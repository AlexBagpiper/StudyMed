<!-- app/templates/teacher/edit_question.html -->
{% extends "base.html" %}

{% block title %}Редактировать вопрос - Панель администратора{% endblock %}

{% block content %}
<h2>Редактировать вопрос</h2>

<form method="POST" action="{{ url_for('database.edit_record', table='questions', id=question.id) }}" enctype="multipart/form-data">
    <div class="mb-3">
        <label for="topic_id" class="form-label">{{ _('Тема теста') }}</label>
        <select class="form-select" id="topic_id" name="topic_id" required>
            {% for topic in topics %}
                <option value="{{ topic.id }}" {% if topic.id == question.topic_id %}selected{% endif %}>
                    {{ topic.name }}
                </option>
            {% endfor %}
        </select>
    </div>
    <div class="mb-3">
        <label for="question_type" class="form-label">Тип вопроса</label>
        <select class="form-select" id="question_type" name="question_type" required onchange="toggleQuestionFields()">
            <option value="open" {{ 'selected' if question.question_type == 'open' }}>Открытый (текстовый)</option>
            <option value="graphic" {{ 'selected' if question.question_type == 'graphic' }}>Графический</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="question_text" class="form-label">Текст вопроса</label>
        <textarea class="form-control" id="question_text" name="question_text" rows="3" required>{{ question.question_text }}</textarea>
    </div>
    <div id="open_fields" style="display: {{ 'block' if question.question_type == 'open' else 'none' }};">
        <div class="mb-3">
            <label for="correct_answer" class="form-label">Правильный ответ (для текстового вопроса)</label>
            <textarea class="form-control" id="correct_answer" name="correct_answer" rows="3" required>{{ question.correct_answer }}</textarea>
        </div>
    </div>
    <div id="graphic_fields" style="display: {{ 'block' if question.question_type == 'graphic' else 'none' }};">
        {% if question.has_image_annotation %}
            <div class="mb-3">
                <label class="form-label">Текущее изображение:</label>
                <img src="{{ url_for('static', filename='uploads/images/' + question.image_annotation.image_file) }}" alt="Текущее изображение" style="max-width: 100%; height: auto;">
            </div>
            <div class="mb-3">
                <label class="form-label">Текущая аннотация:</label>
                <p>{{ question.image_annotation.annotation_file }}</p>
            </div>
        {% endif %}
        <div class="mb-3">
            <label for="image_file" class="form-label">Новый файл изображения (оставьте пустым, чтобы не менять)</label>
            <input type="file" class="form-control" id="image_file" name="image_file" accept=".jpg,.jpeg,.png">
        </div>
        <div class="mb-3">
            <label for="annotation_file" class="form-label">Новый файл аннотации (COCO JSON, оставьте пустым, чтобы не менять)</label>
            <input type="file" class="form-control" id="annotation_file" name="annotation_file" accept=".json">
        </div>
    </div>

    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">Сохранить изменения</button>
        <a href="{{ url_for('database.questions') }}" class="btn btn-secondary">Отмена</a>
    </div>
</form>

<script>
    function toggleQuestionFields() {
        const typeSelect = document.getElementById('question_type');
        const openFields = document.getElementById('open_fields');
        const graphicFields = document.getElementById('graphic_fields');

        if (typeSelect.value === 'open') {
            openFields.style.display = 'block';
            graphicFields.style.display = 'none';
        } else if (typeSelect.value === 'graphic') {
            openFields.style.display = 'none';
            graphicFields.style.display = 'block';
        } else {
            openFields.style.display = 'none';
            graphicFields.style.display = 'none';
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        toggleQuestionFields();
    });
</script>
{% endblock %}