<!-- app/templates/teacher/create_question.html -->
{% extends "base.html" %}

{% block title %}{{ _('Создать вопрос') }} - {{ get_app_name() }}{% endblock %}

{% block content %}
<h2 class="text-center mb-4">{{ _('Создать новый вопрос') }}</h2>

<form method="POST"
      action="{{ url_for('teacher.create_question') }}"
      enctype="multipart/form-data"
      novalidate>

    <div class="mb-3">
        <label for="topic_id" class="form-label">
            {{ _('Тема теста') }} <span class="text-danger">*</span>
        </label>
        <select class="form-select" id="topic_id" name="topic_id" required>
            <option value="">{{ _('Выберите тему...') }}</option>
            {% for topic in topics %}
                <option value="{{ topic.id }}">{{ topic.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="mb-3">
        <label for="question_type" class="form-label">
            {{ _('Тип вопроса') }} <span class="text-danger">*</span>
        </label>
        <select class="form-select" id="question_type" name="question_type" required>
            <option value="open">{{ _('Открытый (текстовый)') }}</option>
            <option value="graphic">{{ _('Графический') }}</option>
        </select>
    </div>

    <div class="mb-3">
        <label for="question_text" class="form-label">
            {{ _('Текст вопроса') }} <span class="text-danger">*</span>
        </label>
        <textarea class="form-control" id="question_text" name="question_text" rows="3" required></textarea>
    </div>

    <!-- Текстовый ответ (показывается при выборе "open") -->
    <div id="open_fields" class="d-none">
        <div class="mb-3">
            <label for="correct_answer" class="form-label">
                {{ _('Правильный ответ') }} <span class="text-danger">*</span>
            </label>
            <textarea class="form-control" id="correct_answer" name="correct_answer" rows="3"></textarea>
        </div>
    </div>

    <!-- Графические файлы (показывается при выборе "graphic") -->
    <div id="graphic_fields" class="d-none">
        <div class="mb-3">
            <label for="image_file" class="form-label">
                {{ _('Изображение') }} (.jpg, .jpeg, .png) <span class="text-danger">*</span>
            </label>
            <input type="file" class="form-control" id="image_file" name="image_file" accept=".jpg,.jpeg,.png">
                    <!-- ★★★ КОНТЕЙНЕР ДЛЯ ПРЕВЬЮ ★★★ -->
                    <div id="image_preview_container" class="mt-3 d-none">
                        <label class="form-label">{{ _('Предпросмотр изображения') }}:</label>
                        <div class="bg-light border rounded p-2 text-center">
                            <img id="image_preview" src="#" alt="{{ _('Превью изображения') }}"
                                 class="img-fluid rounded" style="max-height: 500px; object-fit: contain;">
                        </div>
                    </div>
        </div>
        <div class="mb-3">
            <label for="annotation_file" class="form-label">
                {{ _('Аннотация') }} (.json, COCO) <span class="text-danger">*</span>
            </label>
            <input type="file" class="form-control" id="annotation_file" name="annotation_file" accept=".json">
        </div>
    </div>

    <div class="d-grid gap-2">
        <button type="submit" class="btn btn-primary">
            {{ _('Создать вопрос') }}
        </button>
        <a href="{{ url_for('teacher.index') }}" class="btn btn-secondary">
            {{ _('Отмена') }}
        </a>
    </div>
</form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const typeSelect = document.getElementById('question_type');
    const openFields = document.getElementById('open_fields');
    const graphicFields = document.getElementById('graphic_fields');
    const correctAnswer = document.getElementById('correct_answer');
    const imageFile = document.getElementById('image_file');
    const annotationFile = document.getElementById('annotation_file');
    const form = document.querySelector('form');

    // ★★★ НОВЫЕ ЭЛЕМЕНТЫ ДЛЯ ПРЕВЬЮ ★★★
    const imagePreviewContainer = document.getElementById('image_preview_container');
    const imagePreview = document.getElementById('image_preview');

    if (!typeSelect || !openFields || !graphicFields || !correctAnswer || !imageFile || !annotationFile) {
        console.warn('Не все элементы формы найдены');
        return;
    }

    // ★★★ ФУНКЦИЯ: ОЧИСТИТЬ ПРЕВЬЮ ★★★
    function clearImagePreview() {
        if (imagePreviewContainer) {
            imagePreviewContainer.classList.add('d-none');
            imagePreview.src = '#';
        }
    }

    // ★★★ ФУНКЦИЯ: ОТОБРАЗИТЬ ПРЕВЬЮ ИЗОБРАЖЕНИЯ ★★★
    function previewImage(file) {
        if (!file) {
            clearImagePreview();
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            imagePreview.src = e.target.result;
            imagePreviewContainer.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
    }

    // ★★★ ОБРАБОТКА ВЫБОРА ФАЙЛА ★★★
    if (imageFile) {
        imageFile.addEventListener('change', function() {
            const file = this.files[0];
            if (file && file.type.match('image/jpeg|image/png')) {
                previewImage(file);
            } else {
                clearImagePreview();
            }
        });
    }

    function toggleFields() {
        const type = typeSelect.value;

        if (type === 'open') {
            openFields.classList.remove('d-none');
            graphicFields.classList.add('d-none');

            correctAnswer.required = true;
            imageFile.required = false;
            annotationFile.required = false;

            // ★★★ СКРЫВАЕМ ПРЕВЬЮ ПРИ ПЕРЕКЛЮЧЕНИИ НА ТЕКСТОВЫЙ ВОПРОС ★★★
            clearImagePreview();
        } else if (type === 'graphic') {
            openFields.classList.add('d-none');
            graphicFields.classList.remove('d-none');

            correctAnswer.required = false;
            imageFile.required = true;
            annotationFile.required = true;
        }
    }

    // Валидация перед отправкой
    form.addEventListener('submit', function(e) {
        const type = typeSelect.value;

        if (type === 'open') {
            const answer = correctAnswer.value.trim();
            if (!answer) {
                e.preventDefault();
                alert('{{ _('Пожалуйста, введите правильный ответ.') }}');
                correctAnswer.focus();
                return;
            }
        } else if (type === 'graphic') {
            const imgFiles = imageFile.files.length;
            const annFiles = annotationFile.files.length;
            if (!imgFiles || !annFiles) {
                e.preventDefault();
                alert('{{ _('Пожалуйста, выберите изображение и файл аннотации.') }}');
                return;
            }

            const imgName = imageFile.files[0]?.name || '';
            const annName = annotationFile.files[0]?.name || '';

            const imgExt = imgName.split('.').pop().toLowerCase();
            const annExt = annName.split('.').pop().toLowerCase();

            if (!['jpg', 'jpeg', 'png'].includes(imgExt)) {
                e.preventDefault();
                alert('{{ _('Неверный формат изображения. Разрешены: .jpg, .jpeg, .png') }}');
                return;
            }
            if (annExt !== 'json') {
                e.preventDefault();
                alert('{{ _('Неверный формат аннотации. Разрешён: .json') }}');
                return;
            }
        }
    });

    // Инициализация и отслеживание изменений
    toggleFields();
    typeSelect.addEventListener('change', toggleFields);
});
</script>

{% endblock %}