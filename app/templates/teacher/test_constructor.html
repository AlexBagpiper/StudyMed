<!-- templates/teacher/test_constructor.html -->
{% extends "base.html" %}

{% block title %}{{ _('Конструктор тестов') }} - {{ get_app_name() }}{% endblock %}

{% block content %}
<h2 class="text-center mb-4">{{ _('Конструктор тестов') }}</h2>

<!-- ПЛИТКА 1: Создание нового теста -->
<div class="card mb-4">
  <div class="card-header bg-light">
    <h5 class="mb-0">{{ _('Создать новый тест') }}</h5>
  </div>
  <div class="card-body">
    <form method="POST" action="{{ url_for('teacher.test_constructor') }}" id="create-test-form">
      <div class="mb-3">
        <label for="name" class="form-label">{{ _('Название теста') }} *</label>
        <input type="text" class="form-control" id="name" name="name" value="{{ name }}" required>
      </div>
      <div class="mb-3">
        <label for="description" class="form-label">{{ _('Описание') }}</label>
        <textarea class="form-control" id="description" name="description" rows="2">{{ description }}</textarea>
      </div>

      <!-- Редактор структуры -->
      <div class="mb-3">
        <h6>{{ _('Структура теста') }}</h6>
        <p class="small text-muted">
          {{ _('Добавьте вопросы, указав тему и тип. Система покажет, сколько вопросов доступно.') }}
        </p>

        <div id="structure-container" class="mt-2">
          <!-- Элементы будут добавлены JS -->
        </div>

        <button type="button" class="btn btn-outline-primary btn-sm mt-2" id="add-question-btn">
          <i class="bi bi-plus"></i> {{ _('Добавить вопрос') }}
        </button>

        <input type="hidden" name="structure" id="structure-input" value='{{ structure_raw|safe }}'>
      </div>

      <div class="d-grid">
        <button type="submit" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> {{ _('Создать тест') }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- ПЛИТКА 2: Существующие тесты -->
{% if tests %}
  <!-- Управление: per_page -->
  <div class="mb-4 d-flex justify-content-between align-items-center flex-wrap gap-2">
    <h5 class="mb-0">{{ _('Созданные тесты') }} ({{ pagination.total if pagination else tests|length }})</h5>
    <div class="d-flex gap-2 align-items-center">
      <label for="per_page_select" class="form-label mb-0">{{ _('Записей:') }}</label>
      <select id="per_page_select" class="form-select w-auto" style="max-width: 100px;">
        <option value="10" {% if request.args.get('per_page') == '10' or not request.args.get('per_page') %}selected{% endif %}>10</option>
        <option value="20" {% if request.args.get('per_page') == '20' %}selected{% endif %}>20</option>
        <option value="30" {% if request.args.get('per_page') == '30' %}selected{% endif %}>30</option>
        <option value="50" {% if request.args.get('per_page') == '50' %}selected{% endif %}>50</option>
        <option value="all" {% if request.args.get('per_page') == 'all' %}selected{% endif %}>{{ _('Все') }}</option>
      </select>
    </div>
  </div>

  <form method="GET" class="d-none" id="per_page_form">
    <input type="hidden" name="per_page" id="per_page_input">
  </form>

  <script>
  document.getElementById('per_page_select')?.addEventListener('change', function() {
      document.getElementById('per_page_input').value = this.value;
      document.getElementById('per_page_form').submit();
  });
  </script>

  <div class="table-responsive">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>{{ _('Название') }}</th>
          <th class="d-none d-md-table-cell">{{ _('Описание') }}</th>
          <th class="d-none d-lg-table-cell">{{ _('Темы') }}</th>
          {% if current_user.role == 'admin' %}
          <th>{{ _('Создатель') }}</th>
          {% endif %}
          <th>{{ _('Дата') }}</th>
          <th>{{ _('Варианты') }}</th>
          <th>{{ _('Действия') }}</th>
        </tr>
      </thead>
      <tbody>
        {% for test in tests %}
          <tr>
            <td>
              <strong>{{ test.name }}</strong>
            </td>
            <td class="d-none d-md-table-cell">
              {{ test.description[:80] + '…' if test.description and test.description|length > 80 else test.description or '—' }}
            </td>
            <td class="d-none d-lg-table-cell">
              {% set structure_list = test.structure|from_json %}
              {% set used_topics = structure_list|map(attribute='topic_id')|unique|list %}
              {% if used_topics %}
                {% for tid in used_topics %}
                  <span class="badge bg-info text-dark me-1">
                    {{ topic_map.get(tid, '?') }}
                  </span>
                {% endfor %}
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            {% if current_user.role == 'admin' %}
            <td>{{ test.creator.get_formatted_name() }}</td>
            {% endif %}
            <td>{{ test.created_at.strftime('%Y-%m-%d %H:%M') if test.created_at else '—' }}</td>
            <td>{{ test.variants|length }}</td>
            <td>
              <a href="{{ url_for('teacher.view_test', test_id=test.id) }}?next={{ request.url|urlencode }}"
                 class="btn btn-sm btn-outline-primary"
                 title="{{ _('Просмотр теста и вариантов') }}">
                <i class="bi bi-eye"></i>
              </a>
              <a href="{{ url_for('teacher.edit_test', test_id=test.id) }}?next={{ request.url|urlencode }}"
                 class="btn btn-sm btn-outline-secondary"
                 title="{{ _('Редактировать тест') }}">
                <i class="bi bi-pencil"></i>
              </a>
              <button type="button"
                      class="btn btn-sm btn-outline-danger"
                      title="{{ _('Удалить тест') }}"
                      data-bs-toggle="modal"
                      data-bs-target="#deleteTestModal{{ test.id }}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>

          <!-- Modal удаления теста (упрощённый) -->
          <div class="modal fade" id="deleteTestModal{{ test.id }}" tabindex="-1"
               aria-labelledby="deleteTestModalLabel{{ test.id }}" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header bg-light">
                  <h5 class="modal-title" id="deleteTestModalLabel{{ test.id }}">
                    <i class="bi bi-exclamation-triangle text-danger me-2"></i>
                    {{ _('Удалить тест?') }}
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"
                          aria-label="{{ _('Закрыть') }}"></button>
                </div>
                <div class="modal-body">
                  <p>{{ _('Вы уверены, что хотите удалить тест:') }}<br>
                    <strong class="text-primary">{{ test.name }}</strong>?
                  </p>
                  <p class="text-danger small">
                    <i class="bi bi-info-circle me-1"></i>
                    {{ _('Будут удалены ВСЕ связанные варианты.') }}
                  </p>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> {{ _('Отмена') }}
                  </button>
                  <form method="POST"
                        action="{{ url_for('teacher.delete_test', test_id=test.id) }}?next={{ request.url|urlencode }}"
                        class="d-inline">
                    <button type="submit" class="btn btn-danger">
                      <i class="bi bi-trash"></i> {{ _('Удалить') }}
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Пагинация -->
  {% if pagination and pagination.pages > 1 %}
  <div class="mt-4 mb-4 d-flex justify-content-center">
    <nav aria-label="{{ _('Навигация по страницам') }}">
      <ul class="pagination mb-0">
        {% if pagination.has_prev %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('teacher.test_constructor',
                  page=pagination.prev_num,
                  per_page=request.args.get('per_page')
              ) }}">{{ _('Предыдущая') }}</a>
        </li>
        {% endif %}

        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                <li class="page-item">
                  <a class="page-link" href="{{ url_for('teacher.test_constructor',
                          page=page_num,
                          per_page=request.args.get('per_page')
                      ) }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                  <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">…</span>
            </li>
            {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
        <li class="page-item">
          <a class="page-link" href="{{ url_for('teacher.test_constructor',
                  page=pagination.next_num,
                  per_page=request.args.get('per_page')
              ) }}">{{ _('Следующая') }}</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
  {% endif %}
{% else %}
  <div class="alert alert-info text-center">
    {{ _('Пока нет созданных тестов.') }}
  </div>
{% endif %}

<!-- Кнопки действий -->
<div class="d-grid gap-2">
  <a href="{{ url_for('teacher.index') }}" class="btn btn-secondary">{{ _('Назад в меню преподавателя') }}</a>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('structure-container');
    const template = document.getElementById('question-template');
    const addButton = document.getElementById('add-question-btn');
    const structureInput = document.getElementById('structure-input');
    const form = document.getElementById('create-test-form');

    // === Загрузка статистики вопросов ===
    let questionStats = {};
    fetch('{{ url_for("teacher.stats_api") }}')
        .then(r => r.json())
        .then(data => {
            questionStats = data;
            updateAllStats();
        })
        .catch(err => console.warn('Не удалось загрузить статистику вопросов', err));

    // === Восстановление структуры ===
    let structure = [];
    try {
        const initial = JSON.parse(structureInput.value || '[]');
        if (Array.isArray(initial)) structure = initial;
    } catch (e) {
        console.warn('Invalid initial structure');
    }

    // === Вспомогательные функции ===
    function updateStructureInput() {
        const items = container.querySelectorAll('.question-item');
        const arr = [];
        items.forEach(item => {
            const topicSelect = item.querySelector('.topic-select');
            const typeSelect = item.querySelector('.type-select');
            const tid = parseInt(topicSelect.value);
            const ttype = typeSelect.value;
            if (!isNaN(tid) && ttype) {
                arr.push({ topic_id: tid, question_type: ttype });
            }
        });
        structureInput.value = JSON.stringify(arr);
    }

    function updateItemStats(item) {
        const topicSelect = item.querySelector('.topic-select');
        const typeSelect = item.querySelector('.type-select');
        const statEl = item.querySelector('.stat-badge');

        const tid = topicSelect.value;
        const qtype = typeSelect.value;

        if (!tid || !qtype) {
            if (statEl) statEl.remove();
            return;
        }

        const key = `${tid},${qtype}`;
        const count = questionStats[key] || 0;

        let badge = statEl;
        if (!badge) {
            badge = document.createElement('span');
            badge.className = 'badge ms-2 stat-badge';
            item.querySelector('.input-group').insertBefore(badge, item.querySelector('.remove-btn'));
        }

        badge.textContent = `${count} {{ _('вопросов') }}`;
        badge.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        if (count >= 5) {
            badge.classList.add('bg-success');
        } else if (count >= 2) {
            badge.classList.add('bg-warning');
        } else {
            badge.classList.add('bg-danger');
        }
    }

    function updateAllStats() {
        container.querySelectorAll('.question-item').forEach(updateItemStats);
    }

    function createQuestionItem(data = null) {
        const clone = template.content.cloneNode(true);
        const item = clone.querySelector('.question-item');

        if (data) {
            const topicSelect = item.querySelector('.topic-select');
            const typeSelect = item.querySelector('.type-select');
            topicSelect.value = data.topic_id;
            typeSelect.value = data.question_type;
        }

        item.querySelector('.remove-btn').addEventListener('click', () => {
            item.remove();
            updateStructureInput();
        });

        item.querySelectorAll('select').forEach(sel => {
            sel.addEventListener('change', () => {
                updateStructureInput();
                updateItemStats(item);
            });
        });

        return item;
    }

    // === Инициализация ===
    if (structure.length > 0) {
        structure.forEach(item => container.appendChild(createQuestionItem(item)));
    } else {
        container.appendChild(createQuestionItem());
    }

    addButton.addEventListener('click', () => {
        container.appendChild(createQuestionItem());
    });

    form.addEventListener('submit', function(e) {
        updateStructureInput();
        const items = container.querySelectorAll('.question-item');
        if (items.length === 0) {
            alert({{ _("Добавьте хотя бы один вопрос в структуру.")|tojson|safe }});
            e.preventDefault();
            return false;
        }
    });

    // Flash — 5 сек
    document.querySelectorAll('.flash-message').forEach(el => {
        setTimeout(() => {
            try {
                const alert = bootstrap.Alert.getInstance(el) || new bootstrap.Alert(el);
                alert?.close?.();
            } catch (e) {
                el.style.display = 'none';
            }
        }, 5000);
    });
});
</script>

<!-- Шаблон элемента вопроса -->
<template id="question-template">
  <div class="input-group mb-2 question-item">
    <select class="form-select form-select-sm me-2 topic-select" required>
      <option value="" disabled selected>{{ _('Выберите тему') }}</option>
      {% for topic in topic_choices %}
        <option value="{{ topic.id }}">{{ topic.name }}</option>
      {% endfor %}
    </select>
    <select class="form-select form-select-sm me-2 type-select" required>
      {% for qt in question_types %}
        <option value="{{ qt.value }}">{{ qt.label }}</option>
      {% endfor %}
    </select>
    <button type="button" class="btn btn-outline-danger btn-sm remove-btn">
      <i class="bi bi-trash"></i>
    </button>
  </div>
</template>
{% endblock %}